{# {{ ansible_managed }} #}
{
  "log": {
    "level": "{{ vpn_log_level }}",
    "timestamp": true
  },
  "dns": {
    "servers": [
{% for dns in vpn_dns_servers %}
      {
        "tag": "{{ dns.tag }}",
{% if dns.type == 'udp' %}
        "type": "udp",
        "server": "{{ dns.server }}"
{% elif dns.type == 'https' %}
        "type": "https",
        "server": "{{ dns.server }}",
        "server_port": {{ dns.server_port }},
        "domain_resolver": "{{ dns.domain_resolver }}"
{% endif %}
      }{% if not loop.last %},{% endif %}

{% endfor %}
    ],
    "strategy": "{% if vpn_ipv6_enabled %}prefer_ipv4{% else %}ipv4_only{% endif %}",
    "final": "{{ vpn_dns_servers[-1].tag }}"
  },
  "inbounds": [
    {
      "type": "mixed",
      "tag": "mixed-in",
      "listen": "127.0.0.1",
      "listen_port": {{ vpn_local_proxy_port }},
      "sniff": true,
      "sniff_override_destination": true
    }
  ],
  "outbounds": [
    {
      "tag": "{{ vpn_outbound_common.tag }}",
      "type": "urltest",
      "outbounds": [
{% for server in vpn_servers %}
        "{{ server.name }}-v4"{% if vpn_ipv6_enabled and server.server_ipv6 %},
        "{{ server.name }}-v6"{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
      ],
      "url": "https://www.gstatic.com/generate_204",
      "interval": "5m",
      "tolerance": 50
    },
{% for server in vpn_servers %}
    {% set port_val = server.server_port | default(vpn_outbound_common.server_port) %}
    {% set flow_val = server.flow if server.flow is defined else vpn_outbound_common.flow %}
    {% set transport_val = server.transport if server.transport is defined else vpn_outbound_common.transport %}
    {% set packet_encoding_val = server.packet_encoding if server.packet_encoding is defined else vpn_outbound_common.packet_encoding %}
    {
      "tag": "{{ server.name }}-v4",
      "type": "{{ vpn_outbound_common.type }}",
      "server": "{{ server.server_ipv4 }}",
      "server_port": {{ port_val }},
      "uuid": "{{ server.uuid }}"{% if flow_val %},
      "flow": "{{ flow_val }}"{% endif %}{% if transport_val.type == 'tcp' and packet_encoding_val %},
      "packet_encoding": "{{ packet_encoding_val }}"{% endif %},
      "tls": {
        "enabled": {{ vpn_outbound_common.tls.enabled | lower }},
        "insecure": {{ vpn_outbound_common.tls.insecure | lower }},
        "server_name": "{{ vpn_outbound_common.tls.server_name }}",
        "disable_sni": {{ vpn_outbound_common.tls.disable_sni | lower }},
        "utls": {
          "enabled": {{ vpn_outbound_common.utls.enabled | lower }},
          "fingerprint": "{{ vpn_outbound_common.utls.fingerprint }}"
        },
        "reality": {
          "enabled": {{ vpn_outbound_common.reality.enabled | lower }}{% if vpn_outbound_common.reality.enabled %},
          "public_key": "{{ server.public_key }}",
          "short_id": "{{ server.short_id }}"{% endif %}
        }
      }{% if transport_val.type != 'tcp' %},
      "transport": {
        "type": "{{ transport_val.type }}"{% if transport_val.type == 'xhttp' %},
        "path": "{{ transport_val.path }}",
        "mode": "{{ transport_val.mode }}"{% if transport_val.extra_headers | default({}) %},
        "headers": {{ transport_val.extra_headers | to_json }}{% endif %}
        {% endif %}
      }{% endif %}
    }{% if vpn_ipv6_enabled and server.server_ipv6 %},
    {
      "tag": "{{ server.name }}-v6",
      "type": "{{ vpn_outbound_common.type }}",
      "server": "{{ server.server_ipv6 }}",
      "server_port": {{ port_val }},
      "uuid": "{{ server.uuid }}"{% if flow_val %},
      "flow": "{{ flow_val }}"{% endif %}{% if transport_val.type == 'tcp' and packet_encoding_val %},
      "packet_encoding": "{{ packet_encoding_val }}"{% endif %},
      "tls": {
        "enabled": {{ vpn_outbound_common.tls.enabled | lower }},
        "insecure": {{ vpn_outbound_common.tls.insecure | lower }},
        "server_name": "{{ vpn_outbound_common.tls.server_name }}",
        "disable_sni": {{ vpn_outbound_common.tls.disable_sni | lower }},
        "utls": {
          "enabled": {{ vpn_outbound_common.utls.enabled | lower }},
          "fingerprint": "{{ vpn_outbound_common.utls.fingerprint }}"
        },
        "reality": {
          "enabled": {{ vpn_outbound_common.reality.enabled | lower }}{% if vpn_outbound_common.reality.enabled %},
          "public_key": "{{ server.public_key }}",
          "short_id": "{{ server.short_id }}"{% endif %}
        }
      }{% if transport_val.type != 'tcp' %},
      "transport": {
        "type": "{{ transport_val.type }}"{% if transport_val.type == 'xhttp' %},
        "path": "{{ transport_val.path }}",
        "mode": "{{ transport_val.mode }}"{% if transport_val.extra_headers | default({}) %},
        "headers": {{ transport_val.extra_headers | to_json }}{% endif %}
        {% endif %}
      }{% endif %}
    }{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
  ],
  "route": {
    "default_domain_resolver": "{{ vpn_dns_servers[-1].tag }}",
    "final": "{{ vpn_outbound_common.tag }}",
    "auto_detect_interface": true
  }
}
