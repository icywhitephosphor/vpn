---
# VPN Server Role - x-ui configuration

- name: Ensure sqlite3 is installed
  ansible.builtin.apt:
    name: sqlite3
    state: present
    update_cache: true
  tags: [x-ui, x-ui-config]

- name: Configure x-ui settings in sqlite
  ansible.builtin.shell:
    cmd: |
      set -e
      DB="/etc/x-ui/x-ui.db"
      update_setting() {
        local key="$1"
        local value="$2"
        local current
        current="$(sqlite3 "$DB" "SELECT value FROM settings WHERE key='$key' LIMIT 1;" 2>/dev/null || true)"
        if [ "$current" != "$value" ]; then
          sqlite3 "$DB" "DELETE FROM settings WHERE key='$key';"
          sqlite3 "$DB" "INSERT INTO settings (key, value) VALUES ('$key', '$value');"
          echo "changed"
        fi
      }
      {{ "update_setting 'webDomain' '" ~ vpn_server_domain ~ "'" if vpn_server_domain is defined else "" }}
      update_setting 'webCertFile' '{{ vpn_server_xui_cert_path }}'
      update_setting 'webKeyFile' '{{ vpn_server_xui_key_path }}'
      update_setting 'subEnable' 'false'
  register: xui_settings_update
  changed_when: "'changed' in xui_settings_update.stdout"
  notify: restart x-ui
  tags: [x-ui, x-ui-config]

- name: Remove old private.key file if exists
  ansible.builtin.file:
    path: /etc/x-ui/private.key
    state: absent
  tags: [x-ui, x-ui-config]
