{#- Построим конфиг программно и выведем через to_nice_json -#}
{#- [HYBRID MODE] In hybrid mode, sing-box acts only as TUN gateway, all traffic goes to xray via SOCKS -#}
{%- if _router_vpn_client == 'hybrid' -%}
  {#- Hybrid: only xray-chain outbound, no direct VPN connections -#}
  {%- set outbounds_list = [
    {'tag': 'xray-chain', 'type': 'socks', 'server': '127.0.0.1', 'server_port': router_xray_chain_port, 'udp_over_tcp': false},
    {'tag': 'direct', 'type': 'direct'},
    {'tag': 'block', 'type': 'block'},
    {'tag': 'dns-out', 'type': 'dns'}
  ] -%}
  {%- set dns_servers_list = [
    {'tag': 'remote-dns', 'address': 'tcp://8.8.8.8', 'detour': 'xray-chain'},
    {'tag': 'local-dns', 'address': '8.8.8.8', 'detour': 'direct'}
  ] -%}
  {%- set config = {
    'log': {'level': router_singbox_log_level},
    'dns': {
      'servers': dns_servers_list,
      'strategy': 'ipv4_only',
      'final': 'remote-dns'
    },
    'inbounds': [{
      'type': 'tun',
      'interface_name': router_singbox_inbound.interface_name,
      'domain_strategy': router_singbox_inbound.domain_strategy,
      'address': router_singbox_inbound.address,
      'mtu': router_singbox_inbound.mtu,
      'auto_route': router_singbox_inbound.auto_route,
      'strict_route': router_singbox_inbound.strict_route,
      'sniff': router_singbox_inbound.sniff,
      'stack': router_singbox_inbound.stack,
      'endpoint_independent_nat': router_singbox_inbound.endpoint_independent_nat,
      'udp_timeout': router_singbox_inbound.udp_timeout
    }],
    'outbounds': outbounds_list,
    'route': {
      'auto_detect_interface': router_singbox_route.auto_detect_interface,
      'rules': [
        {'protocol': 'dns', 'outbound': 'dns-out'}
      ],
      'final': 'xray-chain'
    }
  } -%}
{%- else -%}
{#- Standard sing-box mode (non-hybrid) -#}
{%- set dns_servers_list = [] -%}
{%- for dns in router_singbox_dns_servers -%}
  {%- set _ = dns_servers_list.append({'tag': dns.tag, 'address': dns.address, 'detour': vpn_outbound_common.tag}) -%}
{%- endfor -%}
{%- set outbounds_tags = [] -%}
{%- for server in vpn_servers -%}
  {%- set _ = outbounds_tags.append(server.name ~ '-v4') -%}
  {%- if vpn_ipv6_enabled and server.server_ipv6 -%}
    {%- set _ = outbounds_tags.append(server.name ~ '-v6') -%}
  {%- endif -%}
{%- endfor -%}
{%- set outbounds_list = [] -%}
{%- set urltest_outbound = {
  'tag': vpn_outbound_common.tag,
  'type': 'urltest',
  'outbounds': outbounds_tags,
  'url': 'https://www.gstatic.com/generate_204',
  'interval': '5m',
  'tolerance': 50
} -%}
{%- set _ = outbounds_list.append(urltest_outbound) -%}
{%- for server in vpn_servers -%}
  {%- set port_val = server.server_port if server.server_port is defined else vpn_outbound_common.server_port -%}
  {%- set flow_val = server.flow if server.flow is defined else vpn_outbound_common.flow -%}
  {%- set transport_val = server.transport if server.transport is defined else vpn_outbound_common.transport -%}
  {%- set packet_encoding_val = server.packet_encoding if server.packet_encoding is defined else vpn_outbound_common.packet_encoding -%}
  {%- set singbox_transport_type = 'http' if transport_val.type == 'xhttp' else transport_val.type -%}
  {%- set reality_block = {'enabled': vpn_outbound_common.reality.enabled} -%}
  {%- if vpn_outbound_common.reality.enabled -%}
    {%- set reality_block = reality_block | combine({'public_key': server.public_key, 'short_id': server.short_id}) -%}
  {%- endif -%}
  {%- set tls_block = {
    'enabled': vpn_outbound_common.tls.enabled,
    'insecure': vpn_outbound_common.tls.insecure,
    'server_name': vpn_outbound_common.tls.server_name,
    'disable_sni': vpn_outbound_common.tls.disable_sni,
    'utls': {
      'enabled': vpn_outbound_common.utls.enabled,
      'fingerprint': vpn_outbound_common.utls.fingerprint
    },
    'reality': reality_block
  } -%}
  {%- set server_outbound = {
    'tag': server.name ~ '-v4',
    'type': vpn_outbound_common.type,
    'server': server.server_ipv4,
    'server_port': port_val,
    'uuid': server.uuid,
    'tls': tls_block
  } -%}
  {%- if flow_val -%}
    {%- set server_outbound = server_outbound | combine({'flow': flow_val}) -%}
  {%- endif -%}
  {%- if singbox_transport_type == 'tcp' and packet_encoding_val -%}
    {%- set server_outbound = server_outbound | combine({'packet_encoding': packet_encoding_val}) -%}
  {%- endif -%}
  {%- if singbox_transport_type and singbox_transport_type != 'tcp' -%}
    {%- set transport_block = {'type': singbox_transport_type} -%}
    {%- if singbox_transport_type == 'http' -%}
      {%- set transport_block = transport_block | combine({'path': transport_val.path}) -%}
      {%- if transport_val.extra_headers -%}
        {%- set transport_block = transport_block | combine({'headers': transport_val.extra_headers}) -%}
      {%- endif -%}
    {%- endif -%}
    {%- set server_outbound = server_outbound | combine({'transport': transport_block}) -%}
  {%- endif -%}
  {%- set _ = outbounds_list.append(server_outbound) -%}
  {%- if vpn_ipv6_enabled and server.server_ipv6 -%}
    {%- set server_outbound_v6 = server_outbound | combine({'tag': server.name ~ '-v6', 'server': server.server_ipv6}) -%}
    {%- set _ = outbounds_list.append(server_outbound_v6) -%}
  {%- endif -%}
{%- endfor -%}
{%- set _ = outbounds_list.append({'tag': 'direct', 'type': 'direct'}) -%}
{%- set _ = outbounds_list.append({'tag': 'block', 'type': 'block'}) -%}
{%- set _ = outbounds_list.append({'tag': 'dns-out', 'type': 'dns'}) -%}

{%- set inbounds_list = [{
  'type': 'tun',
  'interface_name': router_singbox_inbound.interface_name,
  'domain_strategy': router_singbox_inbound.domain_strategy,
  'address': router_singbox_inbound.address,
  'mtu': router_singbox_inbound.mtu,
  'auto_route': router_singbox_inbound.auto_route,
  'strict_route': router_singbox_inbound.strict_route,
  'sniff': router_singbox_inbound.sniff,
  'stack': router_singbox_inbound.stack,
  'endpoint_independent_nat': router_singbox_inbound.endpoint_independent_nat,
  'udp_timeout': router_singbox_inbound.udp_timeout
}] -%}
{%- if router_proxy_enabled -%}
  {%- set _ = inbounds_list.append({
    'type': 'mixed',
    'listen': '0.0.0.0',
    'listen_port': router_proxy_port,
    'sniff': true
  }) -%}
{%- endif -%}
{%- set config = {
  'log': {'level': router_singbox_log_level},
  'dns': {
    'servers': dns_servers_list,
    'strategy': 'prefer_ipv4' if vpn_ipv6_enabled else 'ipv4_only',
    'final': router_singbox_dns_servers[0].tag
  },
  'inbounds': inbounds_list,
  'outbounds': outbounds_list,
  'route': {
    'auto_detect_interface': router_singbox_route.auto_detect_interface,
    'rules': [
      {'protocol': 'dns', 'outbound': 'dns-out'}
    ],
    'final': vpn_outbound_common.tag
  }
} -%}
{%- endif -%}

{{ config | to_nice_json }}
