{
  "log": {
    "level": "{{ router_singbox_log_level }}"
  },
  "dns": {
    "servers": [
{% for dns in router_singbox_dns_servers %}
      {
        "tag": "{{ dns.tag }}",
        "address": "{{ dns.address }}",
        "detour": "{{ vpn_outbound_common.tag }}"
      }{% if not loop.last %},{% endif %}

{% endfor %}
    ],
    "strategy": "{% if vpn_ipv6_enabled %}prefer_ipv4{% else %}ipv4_only{% endif %}",
    "final": "{{ router_singbox_dns_servers[0].tag }}"
  },
  "inbounds": [
    {
      "type": "tun",
      "interface_name": "{{ router_singbox_inbound.interface_name }}",
      "domain_strategy": "{{ router_singbox_inbound.domain_strategy }}",
      "address": {{ router_singbox_inbound.address | to_json }},
      "mtu": {{ router_singbox_inbound.mtu }},
      "auto_route": {{ router_singbox_inbound.auto_route | lower }},
      "strict_route": {{ router_singbox_inbound.strict_route | lower }},
      "sniff": {{ router_singbox_inbound.sniff | lower }},
      "stack": "{{ router_singbox_inbound.stack }}",
      "endpoint_independent_nat": {{ router_singbox_inbound.endpoint_independent_nat | lower }},
      "udp_timeout": "{{ router_singbox_inbound.udp_timeout }}"
    }{% if router_proxy_enabled %},
    {
      "type": "mixed",
      "listen": "0.0.0.0",
      "listen_port": {{ router_proxy_port }},
      "sniff": true
    }{% endif %}

  ],
  "outbounds": [
    {
      "tag": "{{ vpn_outbound_common.tag }}",
      "type": "urltest",
      "outbounds": [
{% for server in vpn_servers %}
        "{{ server.name }}-v4"{% if vpn_ipv6_enabled and server.server_ipv6 %},
        "{{ server.name }}-v6"{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
      ],
      "url": "https://www.gstatic.com/generate_204",
      "interval": "5m",
      "tolerance": 50
    },
{% for server in vpn_servers %}
    {
      "tag": "{{ server.name }}-v4",
      "type": "{{ vpn_outbound_common.type }}",
      "server": "{{ server.server_ipv4 }}",
      "server_port": {{ vpn_outbound_common.server_port }},
      "uuid": "{{ server.uuid }}"{% if vpn_outbound_common.flow %},
      "flow": "{{ vpn_outbound_common.flow }}"{% endif %},
      "tls": {
        "enabled": {{ vpn_outbound_common.tls.enabled | lower }},
        "insecure": {{ vpn_outbound_common.tls.insecure | lower }},
        "server_name": "{{ vpn_outbound_common.tls.server_name }}",
        "disable_sni": {{ vpn_outbound_common.tls.disable_sni | lower }},
        "utls": {
          "enabled": {{ vpn_outbound_common.utls.enabled | lower }},
          "fingerprint": "{{ vpn_outbound_common.utls.fingerprint }}"
        },
        "reality": {
          "enabled": {{ vpn_outbound_common.reality.enabled | lower }}{% if vpn_outbound_common.reality.enabled %},
          "public_key": "{{ server.public_key }}",
          "short_id": "{{ server.short_id }}"{% endif %}

        }
      }
    }{% if vpn_ipv6_enabled and server.server_ipv6 %},
    {
      "tag": "{{ server.name }}-v6",
      "type": "{{ vpn_outbound_common.type }}",
      "server": "{{ server.server_ipv6 }}",
      "server_port": {{ vpn_outbound_common.server_port }},
      "uuid": "{{ server.uuid }}"{% if vpn_outbound_common.flow %},
      "flow": "{{ vpn_outbound_common.flow }}"{% endif %},
      "tls": {
        "enabled": {{ vpn_outbound_common.tls.enabled | lower }},
        "insecure": {{ vpn_outbound_common.tls.insecure | lower }},
        "server_name": "{{ vpn_outbound_common.tls.server_name }}",
        "disable_sni": {{ vpn_outbound_common.tls.disable_sni | lower }},
        "utls": {
          "enabled": {{ vpn_outbound_common.utls.enabled | lower }},
          "fingerprint": "{{ vpn_outbound_common.utls.fingerprint }}"
        },
        "reality": {
          "enabled": {{ vpn_outbound_common.reality.enabled | lower }}{% if vpn_outbound_common.reality.enabled %},
          "public_key": "{{ server.public_key }}",
          "short_id": "{{ server.short_id }}"{% endif %}

        }
      }
    }{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
  ],
  "route": {
    "auto_detect_interface": {{ router_singbox_route.auto_detect_interface | lower }}
  }
}
