---
# Xray VPN configuration tasks for OpenWrt

- name: Check if xray is installed
  ansible.builtin.shell: |
    opkg list-installed xray-core 2>/dev/null || true
  register: _xray_installed
  changed_when: false

- name: Install xray-core
  ansible.builtin.command: opkg install xray-core
  when: "'xray-core' not in _xray_installed.stdout"
  register: _xray_install
  changed_when: _xray_install.rc == 0

- name: Update package lists (kernel modules)
  ansible.builtin.command: opkg update
  changed_when: false
  register: _opkg_update
  failed_when: false

- name: Ensure TPROXY kernel modules installed
  ansible.builtin.command: opkg install kmod-nft-tproxy kmod-nft-socket kmod-nft-nat
  register: _tproxy_install
  changed_when: _tproxy_install.rc == 0
  failed_when: false
  when: _router_vpn_client != 'hybrid'

- name: Create xray directory
  ansible.builtin.file:
    path: /etc/xray
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy xray configuration
  ansible.builtin.template:
    src: xray-config.json.j2
    dest: /etc/xray/config.json
    owner: root
    group: root
    mode: "0644"
    backup: false
  notify: Restart xray

- name: Create xray init script
  ansible.builtin.copy:
    dest: /etc/init.d/xray
    mode: "0755"
    content: |
      #!/bin/sh /etc/rc.common
      START=99
      STOP=10
      USE_PROCD=1

      start_service() {
          procd_open_instance
          procd_set_param command /usr/bin/xray run -c /etc/xray/config.json
          procd_set_param respawn
          procd_set_param stdout 1
          procd_set_param stderr 1
          procd_close_instance
      }
  notify: Restart xray

- name: Check if xray autostart is enabled
  ansible.builtin.find:
    paths: /etc/rc.d
    patterns: "S*xray"
    file_type: link
  register: _xray_autostart

- name: Enable xray autostart
  ansible.builtin.command:
    cmd: /etc/init.d/xray enable
  when: _xray_autostart.matched == 0
  changed_when: true

- name: Stop and disable sing-box if switching to xray
  ansible.builtin.shell: |
    if [ -f /etc/init.d/sing-box ]; then
      /etc/init.d/sing-box stop 2>/dev/null || true
      /etc/init.d/sing-box disable 2>/dev/null || true
    fi
  when: _router_vpn_client != 'hybrid'
  changed_when: false

# Clean up sing-box artifacts
- name: Remove sing-box hotplug script
  ansible.builtin.file:
    path: /etc/hotplug.d/net/99-vpn-route
    state: absent
  when: _router_vpn_client != 'hybrid'

- name: Remove sing-box vpn routing rule
  ansible.builtin.shell: |
    ip rule del fwmark 0x1 lookup vpn 2>/dev/null || true
    ip route flush table vpn 2>/dev/null || true
  changed_when: false
  when: _router_vpn_client != 'hybrid'

# Deploy xray nftables rules (NOT in /etc/nftables.d/ to avoid fw4 conflict!)
- name: Deploy xray TPROXY nftables rules
  ansible.builtin.template:
    src: xray-tproxy.nft.j2
    dest: /etc/xray/tproxy.nft
    owner: root
    group: root
    mode: "0644"
  register: _xray_nft_rules
  when: _router_vpn_client != 'hybrid'

# Remove old nftables.d file if exists (causes fw4 conflict)
- name: Remove old xray nftables.d file
  ansible.builtin.file:
    path: /etc/nftables.d/99-xray-tproxy.nft
    state: absent
  notify: Reload firewall

- name: Setup TPROXY routing
  ansible.builtin.shell: |
    # Add local route for TPROXY
    ip route show table 100 | grep -q "local default" || ip route add local default dev lo table 100
    # Add ip rule for marked packets (priority 99)
    ip rule show | grep -q "fwmark 0x1 lookup 100" || ip rule add fwmark 0x1 lookup 100 prio 99
  changed_when: false
  when: _router_vpn_client != 'hybrid'

- name: Remove TPROXY routing (Hybrid Mode)
  ansible.builtin.shell: |
    ip rule del fwmark 0x1 lookup 100 2>/dev/null || true
    ip route flush table 100 2>/dev/null || true
  changed_when: false
  when: _router_vpn_client == 'hybrid'

- name: Load xray nftables rules
  ansible.builtin.shell: |
    # Remove old table if exists
    nft delete table ip xray 2>/dev/null || true
    # Load new rules
    nft -f /etc/xray/tproxy.nft
  register: _nft_load
  changed_when: _nft_load.rc == 0
  failed_when: _nft_load.rc not in [0]
  notify:
    - Restart xray
    - Reload firewall
  when: _router_vpn_client != 'hybrid'

- name: Remove xray nftables rules (Hybrid Mode)
  ansible.builtin.shell: |
    nft delete table ip xray 2>/dev/null || true
  changed_when: false
  when: _router_vpn_client == 'hybrid'
  notify: Reload firewall

- name: Create TPROXY route persistence script
  ansible.builtin.copy:
    dest: /etc/hotplug.d/iface/99-xray-tproxy
    mode: "0755"
    content: |
      #!/bin/sh
      # Ensure TPROXY routing and nftables are set up on interface changes
      [ "$ACTION" = "ifup" ] && {
        # Add TPROXY routing
        ip route show table 100 | grep -q "local default" || ip route add local default dev lo table 100
        ip rule show | grep -q "fwmark 0x1 lookup 100" || ip rule add fwmark 0x1 lookup 100 prio 99
        # Load nftables rules if not loaded
        nft list table ip xray >/dev/null 2>&1 || nft -f /etc/xray/tproxy.nft 2>/dev/null || true
      }
  when: _router_vpn_client != 'hybrid'

# Ensure firewall is reloaded to pick up fw4 changes
- name: Reload firewall after xray setup
  ansible.builtin.command:
    cmd: /etc/init.d/firewall reload
  changed_when: false

# Ensure xray is running
- name: Ensure xray is running
  ansible.builtin.command:
    cmd: /etc/init.d/xray restart
  changed_when: false
