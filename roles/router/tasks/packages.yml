---
# Packages installation tasks

- name: Update package lists
  ansible.builtin.command:
    cmd: opkg update
  changed_when: false
  check_mode: false

- name: Install required packages
  ansible.builtin.shell:
    cmd: |
      missing=""
      for pkg in ipset curl ca-bundle ca-certificates; do
        opkg list-installed "$pkg" >/dev/null 2>&1 || missing="$missing $pkg"
      done
      if [ -n "$missing" ]; then
        opkg install $missing
        echo "changed"
      fi
  register: router_packages_install
  changed_when: "'changed' in router_packages_install.stdout"
  check_mode: false

# Performance packages
- name: Install irqbalance
  ansible.builtin.shell:
    cmd: |
      if ! opkg list-installed irqbalance >/dev/null 2>&1; then
        opkg install irqbalance
        echo "changed"
      fi
  register: router_irqbalance_install
  changed_when: "'changed' in router_irqbalance_install.stdout"
  check_mode: false
  when: router_irqbalance_enabled | default(true)

- name: Enable irqbalance in UCI config
  ansible.builtin.shell:
    cmd: |
      current=$(uci -q get irqbalance.irqbalance.enabled || echo "")
      if [ "$current" != "1" ]; then
        uci set irqbalance.irqbalance.enabled='1' && uci commit irqbalance
        echo "changed"
      fi
  register: router_irqbalance_uci
  changed_when: "'changed' in router_irqbalance_uci.stdout"
  when: router_irqbalance_enabled | default(true)

- name: Enable irqbalance service
  ansible.builtin.command:
    cmd: /etc/init.d/irqbalance enable
  changed_when: false
  check_mode: false
  when: router_irqbalance_enabled | default(true)

- name: Start irqbalance service
  ansible.builtin.command:
    cmd: /etc/init.d/irqbalance start
  changed_when: false
  check_mode: false
  when: router_irqbalance_enabled | default(true)
