---
# Sing-box VPN configuration tasks
- name: Update package lists
  ansible.builtin.command: opkg update
  changed_when: false

- name: Install or update sing-box
  ansible.builtin.shell: |
    if ! opkg list-installed sing-box >/dev/null 2>&1; then
      opkg install sing-box
      echo "changed"
    fi
  register: singbox_install
  changed_when: "'changed' in singbox_install.stdout"

- name: Create sing-box directory
  ansible.builtin.file:
    path: /etc/sing-box
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy sing-box configuration
  ansible.builtin.template:
    src: singbox-config.json.j2
    dest: /etc/sing-box/config.json
    owner: root
    group: root
    mode: "0644"
    backup: false
  notify: Restart sing-box

- name: Check if sing-box autostart is enabled
  ansible.builtin.find:
    paths: /etc/rc.d
    patterns: "S*sing-box"
    file_type: link
  register: router_singbox_autostart

- name: Enable sing-box autostart
  ansible.builtin.command:
    cmd: /etc/init.d/sing-box enable
  when: router_singbox_autostart.matched == 0
  changed_when: true

- name: Deploy VPN route hotplug script
  ansible.builtin.template:
    src: 99-vpn-route.j2
    dest: /etc/hotplug.d/net/99-vpn-route
    owner: root
    group: root
    mode: "0755"

- name: Remove old hotplug script from wrong directory
  ansible.builtin.file:
    path: /etc/hotplug.d/iface/99-vpn-route
    state: absent

- name: Stop and disable xray if switching to sing-box
  ansible.builtin.shell: |
    if [ -f /etc/init.d/xray ]; then
      /etc/init.d/xray stop 2>/dev/null || true
      /etc/init.d/xray disable 2>/dev/null || true
    fi
  when: _router_vpn_client != 'hybrid'
  changed_when: false

# Clean up xray artifacts
- name: Remove xray TPROXY hotplug script
  ansible.builtin.file:
    path: /etc/hotplug.d/iface/99-xray-tproxy
    state: absent

- name: Remove xray nft table
  ansible.builtin.shell: |
    nft delete table ip xray 2>/dev/null || true
  changed_when: false

- name: Remove xray TPROXY routing rules
  ansible.builtin.shell: |
    ip rule del fwmark 0x1 lookup 100 2>/dev/null || true
    ip route flush table 100 2>/dev/null || true
  changed_when: false

- name: Ensure sing-box is running (creates tun0)
  ansible.builtin.shell: |
    /etc/init.d/sing-box restart
    # Wait for tun0 to appear
    retry=0
    while [ $retry -lt 15 ]; do
      if ip link show tun0 >/dev/null 2>&1; then
        echo "tun0 is up"
        break
      fi
      sleep 1
      retry=$((retry + 1))
    done
  changed_when: false

- name: Setup sing-box vpn routing table
  ansible.builtin.shell: |
    # Ensure tun0 exists
    if ! ip link show tun0 >/dev/null 2>&1; then
      echo "Error: tun0 does not exist, sing-box might not be running"
      exit 1
    fi
    # Ensure local route exists for marked VPN traffic
    ip route del default table vpn 2>/dev/null || true
    ip route add default dev tun0 table vpn metric 10
    # Add vpn routing table rule
    ip rule show | grep -q "fwmark 0x1.*lookup vpn" || ip rule add fwmark 0x1 lookup vpn prio 100
  changed_when: false

# Ensure firewall is reloaded to pick up fw4 changes
- name: Reload firewall after sing-box setup
  ansible.builtin.command:
    cmd: /etc/init.d/firewall reload
  changed_when: false
